<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Exolynk · Sales Workspace</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --exo-bg: #f4f6f8;
      --exo-panel: #ffffff;
      --exo-panel-alt: #f8fbfb;
      --exo-text: #123b40;
      --exo-muted: #5d7383;
      --exo-subtle: #7f94a2;
      --exo-border: #d9e2ea;
      --exo-divider: #e4ebf0;
      --exo-primary: #0070f2;
      --exo-primary-hover: #3c63fc;
      --exo-success: #2e7d32;
      --exo-warning: #e09d00;
      --exo-radius: 14px;
      --exo-shadow: 0 16px 36px rgba(18, 59, 64, 0.08);
      --kanban-new-bg: #edf4ff;
      --kanban-new-border: #c7dafd;
      --kanban-approval-bg: #fff7e6;
      --kanban-approval-border: #f7d9a5;
      --kanban-picking-bg: #f1fbf2;
      --kanban-picking-border: #c4e9c9;
      --kanban-ready-bg: #e9f7fa;
      --kanban-ready-border: #b7e3ec;
      --kanban-closed-bg: #f2f4f6;
      --kanban-closed-border: #d4d8df;
      --kanban-new-text: #1b5ec9;
      --kanban-approval-text: #b47500;
      --kanban-picking-text: #2f7d32;
      --kanban-ready-text: #1a7a8c;
      --kanban-closed-text: #5c6b77;    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      background: var(--exo-bg);
      color: var(--exo-text);
      font: 14px/1.45 "Poppins", "Segoe UI", sans-serif;
    }

    .app {
      min-height: 100vh;
      display: grid;
      grid-template-rows: auto 1fr auto;
    }

    header {
      background: var(--exo-panel);
      box-shadow: 0 2px 12px rgba(18, 59, 64, 0.08);
      padding: 16px 28px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 18px;
    }

    .brand {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .brand span {
      font-size: 12px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--exo-subtle);
    }

    .brand h1 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
    }

    .header-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .btn {
      border: 1px solid var(--exo-border);
      background: var(--exo-panel);
      color: var(--exo-text);
      padding: 8px 14px;
      border-radius: 10px;
      cursor: pointer;
      font: inherit;
      transition: background 0.2s ease, border-color 0.2s ease, color 0.2s ease;
    }

    .btn:hover { background: var(--exo-panel-alt); }

    .btn.primary {
      background: var(--exo-primary);
      border-color: var(--exo-primary);
      color: #fff;
      font-weight: 600;
    }

    .btn.primary:hover { background: var(--exo-primary-hover); }

    .btn.ghost {
      background: transparent;
    }

    main {
      padding: 28px;
      display: grid;
      gap: 18px;
      grid-template-rows: minmax(320px, 52vh) minmax(320px, 1fr);
    }

    .workspace-top,
    .workspace-bottom {
      background: var(--exo-panel);
      border: 1px solid var(--exo-border);
      border-radius: var(--exo-radius);
      box-shadow: var(--exo-shadow);
      display: flex;
      flex-direction: column;
    }

    .top-header,
    .detail-header {
      padding: 18px 24px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      border-bottom: 1px solid var(--exo-divider);
    }

    .tabs {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 4px;
      border: 1px solid var(--exo-border);
      border-radius: 12px;
      background: var(--exo-panel-alt);
    }

    .tab {
      padding: 6px 14px;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 500;
      color: var(--exo-muted);
      cursor: pointer;
      transition: background 0.2s ease, color 0.2s ease;
    }

    .tab.is-active {
      background: #fff;
      color: var(--exo-text);
      box-shadow: inset 0 0 0 1px var(--exo-border);
    }

    .top-actions {
      display: flex;
      gap: 8px;
    }

    .workspace-content {
      flex: 1;
      display: grid;
      padding: 18px 24px 20px;
      overflow: hidden;
    }

    .kanban {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 14px;
      overflow: auto;
      padding-bottom: 6px;
    }

    .kanban-column {
      background: var(--exo-panel-alt);
      border: 1px dashed var(--exo-border);
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      min-height: 260px;
    }

    .kanban-column header {
      border: none;
      box-shadow: none;
      padding: 12px 14px;
      justify-content: flex-start;
      gap: 10px;
    }

    .kanban-column h3 {
      margin: 0;
      font-size: 14px;
      font-weight: 600;
    }

    .kanban-count {
      margin-left: auto;
      font-size: 12px;
      color: var(--exo-muted);
      background: #fff;
      border-radius: 999px;
      padding: 2px 10px;
    }

    .kanban-cards {
      padding: 12px;
      display: grid;
      gap: 10px;
      overflow: auto;
    }

    .kanban-card {
      background: #fff;
      border: 1px solid var(--exo-border);
      border-radius: 12px;
      padding: 12px;
      display: grid;
      gap: 6px;
      cursor: pointer;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .kanban-card:hover,
    .kanban-card.is-active {
      border-color: var(--exo-primary);
      box-shadow: 0 10px 22px rgba(0, 112, 242, 0.12);
    }

    .kanban-card[draggable="true"] { cursor: grab; }
    .kanban-card.dragging { opacity: 0.6; cursor: grabbing; }
    .kanban-column.is-drop-target { border-style: solid; box-shadow: 0 0 0 2px rgba(0, 112, 242, 0.18); }
    .kanban-column.is-drop-target .kanban-cards { background: rgba(0, 112, 242, 0.06); }

    .kanban-column.kanban-new {
      background: var(--kanban-new-bg);
      border-color: var(--kanban-new-border);
    }

    .kanban-column.kanban-approval {
      background: var(--kanban-approval-bg);
      border-color: var(--kanban-approval-border);
    }

    .kanban-column.kanban-picking {
      background: var(--kanban-picking-bg);
      border-color: var(--kanban-picking-border);
    }

    .kanban-column.kanban-ready {
      background: var(--kanban-ready-bg);
      border-color: var(--kanban-ready-border);
    }

    .kanban-column.kanban-closed {
      background: var(--kanban-closed-bg);
      border-color: var(--kanban-closed-border);
    }

    .kanban-column.kanban-new .kanban-card {
      border-color: var(--kanban-new-border);
    }

    .kanban-column.kanban-approval .kanban-card {
      border-color: var(--kanban-approval-border);
    }

    .kanban-column.kanban-picking .kanban-card {
      border-color: var(--kanban-picking-border);
    }

    .kanban-column.kanban-ready .kanban-card {
      border-color: var(--kanban-ready-border);
    }

    .kanban-column.kanban-closed .kanban-card {
      border-color: var(--kanban-closed-border);
    }

    .kanban-column .kanban-card:hover,
    .kanban-column .kanban-card.is-active {
      border-color: var(--exo-primary);
      box-shadow: 0 10px 22px rgba(0, 112, 242, 0.12);
    }
    .kanban-card strong { font-size: 14px; }

    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 12px;
      color: var(--exo-muted);
    }

    .pill {
      padding: 4px 10px;
      border-radius: 999px;
      background: var(--exo-panel-alt);
      border: 1px solid var(--exo-border);
    }

    .pill.ok {
      color: var(--exo-success);
      border-color: rgba(46, 125, 50, 0.35);
    }

    .pill.warn {
      color: var(--exo-warning);
      border-color: rgba(224, 157, 0, 0.35);
    }

    .kanban-column.kanban-new header h3,
    .kanban-column.kanban-new .kanban-count,
    .kanban-column.kanban-new .pill {
      color: var(--kanban-new-text);
    }

    .kanban-column.kanban-new .kanban-count,
    .kanban-column.kanban-new .pill {
      background: rgba(27, 94, 201, 0.08);
      border-color: var(--kanban-new-border);
    }

    .kanban-column.kanban-approval header h3,
    .kanban-column.kanban-approval .kanban-count,
    .kanban-column.kanban-approval .pill {
      color: var(--kanban-approval-text);
    }

    .kanban-column.kanban-approval .kanban-count,
    .kanban-column.kanban-approval .pill {
      background: rgba(180, 117, 0, 0.08);
      border-color: var(--kanban-approval-border);
    }

    .kanban-column.kanban-picking header h3,
    .kanban-column.kanban-picking .kanban-count,
    .kanban-column.kanban-picking .pill {
      color: var(--kanban-picking-text);
    }

    .kanban-column.kanban-picking .kanban-count,
    .kanban-column.kanban-picking .pill {
      background: rgba(47, 125, 50, 0.08);
      border-color: var(--kanban-picking-border);
    }

    .kanban-column.kanban-ready header h3,
    .kanban-column.kanban-ready .kanban-count,
    .kanban-column.kanban-ready .pill {
      color: var(--kanban-ready-text);
    }

    .kanban-column.kanban-ready .kanban-count,
    .kanban-column.kanban-ready .pill {
      background: rgba(26, 122, 140, 0.08);
      border-color: var(--kanban-ready-border);
    }

    .kanban-column.kanban-closed header h3,
    .kanban-column.kanban-closed .kanban-count,
    .kanban-column.kanban-closed .pill {
      color: var(--kanban-closed-text);
    }

    .kanban-column.kanban-closed .kanban-count,
    .kanban-column.kanban-closed .pill {
      background: rgba(92, 107, 119, 0.08);
      border-color: var(--kanban-closed-border);
    }

    .list-view {
      display: none;
      overflow: auto;
    }

    .list-view tbody tr {
      border-left: 4px solid transparent;
      transition: background 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .list-view tbody tr[data-state="new"] { border-left-color: var(--kanban-new-border); }
    .list-view tbody tr[data-state="approval"] { border-left-color: var(--kanban-approval-border); }
    .list-view tbody tr[data-state="picking"] { border-left-color: var(--kanban-picking-border); }
    .list-view tbody tr[data-state="ready"] { border-left-color: var(--kanban-ready-border); }
    .list-view tbody tr[data-state="closed"] { border-left-color: var(--kanban-closed-border); }

    .list-view tbody tr[data-state="new"].is-active,
    .list-view tbody tr[data-state="new"]:hover {
      background: rgba(27, 94, 201, 0.05);
      box-shadow: inset 0 0 0 1px rgba(27, 94, 201, 0.18);
    }

    .list-view tbody tr[data-state="approval"].is-active,
    .list-view tbody tr[data-state="approval"]:hover {
      background: rgba(180, 117, 0, 0.06);
      box-shadow: inset 0 0 0 1px rgba(180, 117, 0, 0.2);
    }

    .list-view tbody tr[data-state="picking"].is-active,
    .list-view tbody tr[data-state="picking"]:hover {
      background: rgba(47, 125, 50, 0.05);
      box-shadow: inset 0 0 0 1px rgba(47, 125, 50, 0.18);
    }

    .list-view tbody tr[data-state="ready"].is-active,
    .list-view tbody tr[data-state="ready"]:hover {
      background: rgba(26, 122, 140, 0.05);
      box-shadow: inset 0 0 0 1px rgba(26, 122, 140, 0.18);
    }

    .list-view tbody tr[data-state="closed"].is-active,
    .list-view tbody tr[data-state="closed"]:hover {
      background: rgba(92, 107, 119, 0.05);
      box-shadow: inset 0 0 0 1px rgba(92, 107, 119, 0.18);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    thead {
      background: var(--exo-panel-alt);
      color: var(--exo-subtle);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    th, td {
      padding: 12px 14px;
      border-bottom: 1px solid var(--exo-divider);
      text-align: left;
    }

    tbody tr:hover {
      background: rgba(0, 112, 242, 0.05);
    }

    tbody tr.is-active {
      background: rgba(0, 112, 242, 0.1);
    }

    .orders-detail[data-mode="edit"] {
      border-color: var(--exo-primary);
      box-shadow: 0 18px 40px rgba(0, 112, 242, 0.12);
    }

    .detail-header h2 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
    }

    .status-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid var(--exo-border);
      background: #fff;
      font-size: 12px;
      font-weight: 500;
    }

    .chip::before {
      content: "";
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--exo-muted);
    }

    .chip.status::before { background: var(--exo-primary); }
    .chip.ship::before { background: var(--exo-warning); }
    .chip.payment::before { background: var(--exo-muted); }

    .actions-edit { display: none; gap: 8px; }
    .actions-view { display: flex; gap: 8px; }

    .orders-detail[data-mode="edit"] .actions-view { display: none; }
    .orders-detail[data-mode="edit"] .actions-edit { display: flex; }

    .progress-track {
      display: flex;
      gap: 12px;
      align-items: center;
      padding: 10px 24px 16px;
      border-bottom: 1px solid var(--exo-divider);
      flex-wrap: wrap;
    }

    .detail-panel[data-mode="edit"] .progress-step { cursor: pointer; }
    .detail-panel[data-mode="edit"] .progress-step:hover { box-shadow: 0 10px 24px rgba(18, 59, 64, 0.12); }

    .detail-panel[data-mode="view"] .edit-only { display: none; }
    .detail-panel[data-mode="edit"] .view-only { display: none; }
    .detail-panel[data-mode="edit"] .info-cell { background: #fff; border-color: rgba(18,59,64,0.15); box-shadow: inset 0 0 0 1px rgba(0,0,0,0.03); }
    .info-cell[data-role="client-summary"] { cursor: pointer; transition: background 0.2s ease, box-shadow 0.2s ease; }
    .info-cell[data-role="client-summary"]:hover { background: var(--exo-panel-alt); box-shadow: 0 10px 24px rgba(18, 59, 64, 0.08); }
    .detail-panel[data-mode="edit"] input,
    .detail-panel[data-mode="edit"] select,
    .detail-panel[data-mode="edit"] textarea { width: 100%; padding: 8px 10px; border-radius: 8px; border: 1px solid var(--exo-border); font: inherit; color: var(--exo-text); background: #fff; }
    .detail-panel[data-mode="edit"] label { font-size: 12px; color: var(--exo-subtle); letter-spacing: 0.04em; text-transform: uppercase; }
    .edit-hint-inline { font-size: 12px; color: var(--exo-muted); }
    .items-edit-table input { width: 100%; border-radius: 6px; padding: 6px 8px; border: 1px solid var(--exo-border); }
    .items-edit-table input[type="number"] { text-align: right; }
    .items-edit-table th { text-transform: uppercase; font-size: 11px; letter-spacing: 0.05em; color: var(--exo-subtle); }
    .items-edit-table .sum-cell { text-align: right; font-weight: 600; }
    .items-edit-table .sum-display { display: inline-block; min-width: 80px; text-align: right; }
    .items-edit-actions { display: flex; justify-content: space-between; align-items: center; padding: 12px 0 0; }
    .btn-secondary { border: 1px solid var(--exo-border); background: #fff; border-radius: 10px; padding: 8px 14px; cursor: pointer; font: inherit; }
    .btn-secondary:hover { background: var(--exo-panel-alt); }
    .progress-step {
      --progress-accent: var(--exo-muted);
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 6px 16px;
      border-radius: 14px;
      border: 1px solid var(--exo-border);
      background: #fff;
      font-size: 12px;
      font-weight: 500;
      color: var(--progress-accent);
      transition: background 0.2s ease, border-color 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
    }

    .progress-step::before {
      content: attr(data-step);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 1px solid var(--exo-border);
      background: var(--exo-panel-alt);
      font-weight: 600;
      font-size: 12px;
      color: var(--progress-accent);
      transition: background 0.2s ease, border-color 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
    }

    .progress-step.state-new {
      --progress-accent: #1b5ec9;
      border-color: rgba(27, 94, 201, 0.35);
      background: rgba(27, 94, 201, 0.08);
    }

    .progress-step.state-new::before {
      border-color: rgba(27, 94, 201, 0.45);
      background: rgba(27, 94, 201, 0.18);
    }

    .progress-step.state-approval {
      --progress-accent: #b47500;
      border-color: rgba(180, 117, 0, 0.38);
      background: rgba(180, 117, 0, 0.1);
    }

    .progress-step.state-approval::before {
      border-color: rgba(180, 117, 0, 0.5);
      background: rgba(180, 117, 0, 0.24);
    }

    .progress-step.state-picking {
      --progress-accent: #2f7d32;
      border-color: rgba(46, 125, 50, 0.35);
      background: rgba(46, 125, 50, 0.1);
    }

    .progress-step.state-picking::before {
      border-color: rgba(46, 125, 50, 0.45);
      background: rgba(46, 125, 50, 0.24);
    }

    .progress-step.state-ready {
      --progress-accent: #1a7a8c;
      border-color: rgba(26, 122, 140, 0.35);
      background: rgba(26, 122, 140, 0.1);
    }

    .progress-step.state-ready::before {
      border-color: rgba(26, 122, 140, 0.45);
      background: rgba(26, 122, 140, 0.24);
    }

    .progress-step.state-closed {
      --progress-accent: #5c6b77;
      border-color: rgba(92, 107, 119, 0.35);
      background: rgba(92, 107, 119, 0.1);
    }

    .progress-step.state-closed::before {
      border-color: rgba(92, 107, 119, 0.45);
      background: rgba(92, 107, 119, 0.24);
    }

    .progress-step.is-done {
      opacity: 0.75;
    }

    .progress-step.is-done::before {
      background: #fff;
      box-shadow: inset 0 0 0 1px var(--progress-accent);
    }

    .progress-step.is-current {
      opacity: 1;
      color: #fff;
      font-weight: 600;
      transform: translateY(-2px);
      position: relative;
      background: var(--progress-accent);
      border-color: var(--progress-accent);
      box-shadow: 0 10px 24px rgba(18, 59, 64, 0.18);
    }

    .progress-step.is-current::before {
      background: rgba(255, 255, 255, 0.95);
      color: var(--progress-accent);
      border-color: rgba(255, 255, 255, 0.9);
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.6);
    }

    .progress-step.is-current::after {
      content: "";
      position: absolute;
      left: 12px;
      right: 12px;
      bottom: -6px;
      height: 4px;
      border-radius: 999px;
      background: var(--progress-accent);
      opacity: 0.85;
    }

    .progress-step.is-current.state-new { box-shadow: 0 10px 24px rgba(27, 94, 201, 0.32); }
    .progress-step.is-current.state-approval { box-shadow: 0 10px 24px rgba(180, 117, 0, 0.36); }
    .progress-step.is-current.state-picking { box-shadow: 0 10px 24px rgba(46, 125, 50, 0.32); }
    .progress-step.is-current.state-ready { box-shadow: 0 10px 24px rgba(26, 122, 140, 0.34); }
    .progress-step.is-current.state-closed { box-shadow: 0 10px 24px rgba(92, 107, 119, 0.26); }
    .detail-body {
      flex: 1;
      padding: 18px 24px 24px;
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 0.8fr);
      gap: 24px;
      align-items: start;
      overflow: auto;
    }

    .section {
      display: grid;
      gap: 16px;
    }

    .section h3 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px 20px;
    }

    .info-cell {
      background: var(--exo-panel-alt);
      border-radius: 12px;
      border: 1px solid var(--exo-border);
      padding: 12px 16px;
      display: grid;
      gap: 4px;
    }

    .info-cell span {
      font-size: 12px;
      color: var(--exo-subtle);
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    .info-cell strong {
      font-size: 15px;
      font-weight: 600;
    }

    .info-cell small {
      font-size: 12px;
      color: var(--exo-muted);
    }

    .table-wrapper {
      border: 1px solid var(--exo-border);
      border-radius: 12px;
      overflow: hidden;
    }

    .timeline {
      border-left: 2px solid var(--exo-border);
      padding-left: 16px;
      display: grid;
      gap: 12px;
    }

    .timeline-entry {
      display: grid;
      gap: 4px;
    }

    .timeline-entry time {
      font-size: 12px;
      color: var(--exo-subtle);
    }

    .timeline-entry p {
      margin: 0;
      font-size: 13px;
    }

    .edit-hint {
      display: none;
      font-size: 12px;
      color: var(--exo-muted);
      padding-top: 8px;
    }

    .orders-detail[data-mode="edit"] .edit-hint { display: block; }

    footer {
      padding: 18px 28px 28px;
      font-size: 12px;
      color: var(--exo-subtle);
      display: flex;
      justify-content: space-between;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .primary-tabs {
      background: #fff;
      border: 1px solid var(--exo-border);
      box-shadow: inset 0 0 0 1px rgba(18, 59, 64, 0.04);
    }

    .primary-tabs .tab {
      font-weight: 600;
    }

    .view-tabs {
      background: transparent;
      border: none;
      padding: 0;
      gap: 6px;
    }

    .view-tabs .tab {
      border: 1px solid transparent;
      border-radius: 8px;
      padding: 6px 12px;
    }

    .view-tabs .tab.is-active {
      border-color: var(--exo-border);
      background: #fff;
    }

    .workspace-top[data-view="orders"] [data-role="clients-actions"] { display: none; }
    .workspace-top[data-view="clients"] [data-role="orders-actions"] { display: none; }
    .workspace-top[data-view="clients"] [data-role="view-tabs"] { display: none; }

    .orders-workspace {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
      height: 100%;
    }

    .workspace-top[data-view="clients"] .orders-workspace { display: none; }

    .clients-workspace {
      display: none;
      height: 100%;
      overflow: auto;
    }

    .workspace-top[data-view="clients"] .clients-workspace { display: block; }

    .clients-table {
      width: 100%;
      min-width: 680px;
      border-collapse: collapse;
    }

    .clients-table thead th {
      text-align: left;
      font-size: 12px;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: var(--exo-subtle);
      padding: 10px 14px;
      border-bottom: 1px solid var(--exo-divider);
    }

    .clients-table tbody td {
      padding: 12px 14px;
      font-size: 13px;
      border-bottom: 1px solid var(--exo-divider);
      color: var(--exo-text);
      white-space: nowrap;
    }

    .clients-table tbody td:nth-child(1) {
      white-space: normal;
    }

    .clients-table tbody tr {
      cursor: pointer;
      transition: background 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
      border-left: 4px solid transparent;
    }

    .clients-table tbody tr:hover {
      background: rgba(0, 112, 242, 0.05);
      border-left-color: rgba(0, 112, 242, 0.35);
    }

    .clients-table tbody tr.is-active {
      background: rgba(0, 112, 242, 0.08);
      border-left-color: var(--exo-primary);
      box-shadow: inset 0 0 0 1px rgba(0, 112, 242, 0.18);
    }

    .workspace-bottom[data-view="orders"] .client-detail { display: none; }
    .workspace-bottom[data-view="clients"] .orders-detail { display: none; }

    .client-detail {
      display: none;
      flex-direction: column;
      height: 100%;
    }

    .workspace-bottom[data-view="clients"] .client-detail { display: flex; }

    .client-detail-body {
      display: grid;
      gap: 18px;
      padding: 18px 24px 24px;
      grid-template-columns: minmax(280px, 360px) 1fr;
      align-items: start;
    }

    .client-info-card {
      display: grid;
      gap: 12px;
    }

    .client-info-grid {
      display: grid;
      gap: 12px;
    }

    .client-info-grid .info-cell strong {
      font-size: 14px;
    }

    .client-notes p {
      margin: 4px 0 0;
      color: var(--exo-muted);
      font-size: 13px;
      line-height: 1.45;
    }

    .client-orders-card {
      background: #fff;
      border: 1px solid var(--exo-border);
      border-radius: 12px;
      padding: 18px;
      display: grid;
      gap: 12px;
    }

    .client-orders-card h3 {
      margin: 0;
      font-size: 15px;
      font-weight: 600;
    }

    .client-orders-table {
      width: 100%;
      border-collapse: collapse;
    }

    .client-orders-table th,
    .client-orders-table td {
      padding: 10px 12px;
      border-bottom: 1px solid var(--exo-divider);
      text-align: left;
      font-size: 13px;
    }

    .client-orders-table thead th {
      font-size: 12px;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: var(--exo-subtle);
    }

    .client-orders-table tbody tr:last-child td { border-bottom: none; }


    @media (max-width: 1024px) {
      main {
        grid-template-rows: 1fr 1fr;
      }
      .detail-body {
        grid-template-columns: 1fr;
      }
    }


    @media (max-width: 1024px) {
      .client-detail-body {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 720px) {
      .clients-table {
        min-width: 100%;
      }
      .clients-table tbody td {
        white-space: normal;
      }
      .client-detail-body {
        grid-template-columns: 1fr;
      }
      .client-orders-card {
        padding: 14px;
      }
    }

    @media (max-width: 720px) {
      header {
        flex-direction: column;
        align-items: flex-start;
      }
      .top-header, .detail-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }
      .tabs {
        width: 100%;
        justify-content: space-between;
      }
      .top-actions {
        width: 100%;
        justify-content: flex-start;
      }
      .progress-track {
        padding: 12px 16px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <span>Exolynk · Sales workspace</span>
        <h1>Kundenbestellungen</h1>
      </div>
      <div class="header-actions">
        <button class="btn">Import</button>
        <button class="btn">Filter anpassen</button>
        <button class="btn primary">Bestellung erstellen</button>
      </div>
    </header>

    <main>
      <section class="workspace-top" data-mode="kanban" data-view="orders">
        <div class="top-header">
          <div class="header-left">
            <div class="tabs primary-tabs" data-role="main-tabs">
              <span class="tab main-tab is-active" data-view="orders">Bestellungen</span>
              <span class="tab main-tab" data-view="clients">Kunden</span>
            </div>
            <div class="tabs view-tabs" data-role="view-tabs">
              <span class="tab view-tab is-active" data-mode="kanban">Kanban</span>
              <span class="tab view-tab" data-mode="list">Liste</span>
            </div>
          </div>
          <div class="top-actions" data-role="orders-actions">
            <button class="btn">Import</button>
            <button class="btn">Filter anpassen</button>
            <button class="btn primary">Bestellung erstellen</button>
          </div>
          <div class="top-actions" data-role="clients-actions">
            <button class="btn">Kunden importieren</button>
            <button class="btn primary">Kunde hinzufügen</button>
          </div>
        </div>
        <div class="workspace-content">
          <div class="orders-workspace" data-view="orders">
            <div class="kanban" id="kanbanView"></div>
            <div class="list-view" id="listView"></div>
          </div>
          <div class="clients-workspace" data-view="clients">
            <div class="table-wrapper">
              <table class="clients-table">
                <thead>
                  <tr>
                    <th>&#1048;&#1084;&#1103; &#1082;&#1083;&#1080;&#1077;&#1085;&#1090;&#1072;</th>
                    <th>Telefon</th>
                    <th>Email</th>
                    <th>Status</th>
                    <th>Verantwortlich</th>
                  </tr>
                </thead>
                <tbody id="clientsTableBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <section class="workspace-bottom" data-view="orders">
        <div class="detail-panel orders-detail" data-mode="view" data-order="ORD-8745" data-state="APPROVAL">
        <div class="detail-header">
          <div>
            <h2 id="detailOrderTitle">ORD-8745 · Bestelldetails</h2>
            <div class="status-bar">
              <span class="chip status" id="statusChip">Status: In Bearbeitung</span>
              <span class="chip payment" id="paymentChip">Zahlung: nicht erhalten</span>
              <span class="chip ship" id="shipChip">Versand: 28.09.2025</span>
            </div>
          </div>
          <div class="header-actions">
            <div class="actions-view">
              
              <button class="btn" data-action="edit">Bestellung bearbeiten</button>
              <button class="btn ghost" data-action="print">Drucken</button>
            </div>
            <div class="actions-edit">
              <button class="btn primary" data-action="save">Änderungen speichern</button>
              <button class="btn" data-action="cancel">Abbrechen</button>
              <button class="btn ghost" data-action="print">Drucken</button>
            </div>
          </div>
        </div>

        <div class="progress-track">
          <span class="progress-step is-done state-new" data-step="1" data-state="NEW">Sales · Erstellung</span>
          <span class="progress-step is-current state-approval" data-step="2" data-state="APPROVAL">Manager · Bestätigung</span>
          <span class="progress-step state-picking" data-step="3" data-state="PICKING">Logistics · Kommissionierung</span>
          <span class="progress-step state-ready" data-step="4" data-state="READY">Ready · Zur Abholung</span>
          <span class="progress-step state-closed" data-step="5" data-state="CLOSED">Closed</span>
        </div>

        <div class="detail-body">

          <div class="section">

            <h3>Allgemein</h3>

            <div class="info-grid">

              <div class="info-cell" data-role="client-summary">

                <span>Kunde</span>

                <strong id="detailClientName">OOO «Altair Industries»</strong>

                <small id="detailClientContact">Kontakt: Irina Sokolova · +48 600 333 11</small>

              </div>

              <div class="info-cell">

                <span>Verantwortlich</span>

                <strong id="detailOwnerName">Anna Petrowa</strong>

                <small id="detailOwnerRole">Rolle: Sales</small>

              </div>

              <div class="info-cell view-only">

                <span>Bestellsumme</span>

                <strong id="orderAmountView">12 540 CHF</strong>

                <small id="detailDiscountNote">Kein Rabatt angewendet</small>

              </div>

              <div class="info-cell edit-only">

                <span>Bestellsumme</span>

                <strong id="orderAmountEdit">12 540 CHF</strong>

                <small>Summe wird automatisch berechnet</small>

              </div>

            </div>



            <div class="section">

              <h3>Waren</h3>

              <div class="table-wrapper view-only">

                <table>

                  <thead>

                    <tr>

                      <th>Artikel-Nr.</th>

                      <th>Bezeichnung</th>

                      <th>Menge</th>

                      <th>Preis, CHF</th>

                      <th>Summe, CHF</th>

                    </tr>

                  </thead>

                  <tbody id="itemsViewBody"></tbody>

                </table>

              </div>

              <div class="table-wrapper edit-only">

                <table class="items-edit-table">

                  <thead>

                    <tr>

                      <th>Artikel-Nr.</th>

                      <th>Bezeichnung</th>

                      <th>Menge</th>

                      <th>Preis, CHF</th>

                      <th>Summe, CHF</th>

                    </tr>

                  </thead>

                  <tbody id="itemsEditBody"></tbody>

                </table>

                <div class="items-edit-actions">

                  <button class="btn-secondary" id="addItemBtn">Position hinzufügen</button>

                  <span class="edit-hint-inline">Summe wird automatisch berechnet</span>

                </div>

              </div>

            </div>

          </div>



          <aside class="section">

            <h3>Historie</h3>

            <div class="timeline" id="timelineList">

              <div class="timeline-entry">

                <time>26.09 · 10:18 · Logistics</time>

                <p>Es wird zusätzliche Verpackung benötigt, wir klären die Verfügbarkeit ab.</p>

              </div>

              <div class="timeline-entry">

                <time>25.09 · 17:42 · Sales</time>

                <p>Kunde hat beschleunigte Lieferung bestätigt, wir warten auf Zahlung.</p>

              </div>

              <div class="timeline-entry">

                <time>25.09 · 09:05 · Sales</time>

                <p>ORD-8745 erstellt und an Manager zur Bestätigung übergeben.</p>

              </div>

            </div>

          </aside>


        </div>
        </div>
        <div class="detail-panel client-detail" data-view="clients">
          <div class="detail-header">
            <div>
              <h2 id="clientDetailName">Kunde</h2>
              <div class="client-meta">
                <span class="chip status" id="clientStatusChip">Status</span>
                <span class="chip owner" id="clientOwnerChip">Verantwortlich</span>
              </div>
            </div>
            <div class="header-actions">
              <button class="btn ghost" data-client-action="message">Kontaktieren</button>
              <button class="btn" data-client-action="export">Export</button>
              <button class="btn primary" data-client-action="edit">Bearbeiten</button>
            </div>
          </div>
          <div class="client-detail-body">
            <div class="client-info-card">
              <div class="client-info-grid">
                <div class="info-cell">
                  <span>Telefon</span>
                  <strong id="clientDetailPhone">—</strong>
                </div>
                <div class="info-cell">
                  <span>E-Mail</span>
                  <strong id="clientDetailEmail">—</strong>
                </div>
                <div class="info-cell">
                  <span>Adresse</span>
                  <strong id="clientDetailAddress">—</strong>
                </div>
                <div class="info-cell">
                  <span>Erstellungsdatum</span>
                  <strong id="clientDetailCreated">—</strong>
                </div>
                <div class="info-cell">
                  <span>Verantwortlich</span>
                  <strong id="clientDetailOwner">—</strong>
                </div>
              </div>
              <div class="info-cell client-notes">
                <span>Notizen</span>
                <p id="clientDetailNotes">—</p>
              </div>
            </div>
            <div class="client-orders-card">
              <h3>Kundenbestellungen</h3>
              <div class="table-wrapper">
                <table class="client-orders-table">
                  <thead>
                    <tr>
                      <th>Bestellnummer</th>
                      <th>Datum</th>
                      <th>Summe</th>
                      <th>Bestellzustand</th>
                      <th>Bestellstatus</th>
                      <th>Zahlung</th>
                      <th>Versand</th>
                    </tr>
                  </thead>
                  <tbody id="clientOrdersBody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer>
      <span>Sales Workspace · Rolle: Sales</span>
      <span>Letztes Update: 26.09.2025 · 10:18</span>
    </footer>
  </div>

  <script>
  const workspaceTop = document.querySelector('.workspace-top');
  const workspaceBottom = document.querySelector('.workspace-bottom');
  const mainTabs = document.querySelectorAll('.main-tab');
  const viewTabs = document.querySelectorAll('.view-tab');
  const viewTabsContainer = document.querySelector('[data-role="view-tabs"]');
  const ordersWorkspace = document.querySelector('.orders-workspace');
  const clientsWorkspace = document.querySelector('.clients-workspace');
  const ordersActions = document.querySelector('[data-role="orders-actions"]');
  const clientsActions = document.querySelector('[data-role="clients-actions"]');
  const kanbanView = document.getElementById('kanbanView');
  const listView = document.getElementById('listView');
  const clientsTableBody = document.getElementById('clientsTableBody');
  const detailPanel = document.querySelector('.detail-panel.orders-detail');
  const clientDetailPanel = document.querySelector('.detail-panel.client-detail');
  const clientDetailName = clientDetailPanel?.querySelector('#clientDetailName');
  const clientStatusChip = clientDetailPanel?.querySelector('#clientStatusChip');
  const clientOwnerChip = clientDetailPanel?.querySelector('#clientOwnerChip');
  const clientDetailPhone = clientDetailPanel?.querySelector('#clientDetailPhone');
  const clientDetailEmail = clientDetailPanel?.querySelector('#clientDetailEmail');
  const clientDetailAddress = clientDetailPanel?.querySelector('#clientDetailAddress');
  const clientDetailCreated = clientDetailPanel?.querySelector('#clientDetailCreated');
  const clientDetailOwner = clientDetailPanel?.querySelector('#clientDetailOwner');
  const clientDetailNotes = clientDetailPanel?.querySelector('#clientDetailNotes');
  const clientOrdersBody = clientDetailPanel?.querySelector('#clientOrdersBody');

  let activeMainView = workspaceTop?.dataset.view || 'orders';
  let activeClientId = null;


  const STATE_FLOW = [
    { id: 'NEW', title: 'Neu', listLabel: 'Neu', columnClass: 'kanban-new' },
    { id: 'APPROVAL', title: 'In Bestätigung', listLabel: 'In Bestätigung', columnClass: 'kanban-approval' },
    { id: 'PICKING', title: 'Kommissionierung', listLabel: 'Kommissionierung', columnClass: 'kanban-picking' },
    { id: 'READY', title: 'Bereit zur Abholung', listLabel: 'Bereit zur Abholung', columnClass: 'kanban-ready' },
    { id: 'CLOSED', title: 'Geschlossen', listLabel: 'Geschlossen', columnClass: 'kanban-closed' },
  ];
  const STATE_LOOKUP = STATE_FLOW.reduce((acc, state) => {
    acc[state.id] = state;
    return acc;
  }, {});

  const extractDateLabel = when => {
    if (!when) {
      return '?';
    }
    const parts = String(when).split(' ');
    return parts[0] || when;
  };

  const orders = [
    {
      id: 'ORD-9121',
      state: 'NEW',
      clientName: 'VeloParts',
      clientContact: 'Kontakt: Christina Rosch · +41 22 555 12 12',
      ownerName: 'Igor Kowalew',
      ownerRole: 'Sales',
      paymentStatus: 'Zahlung: nicht erhalten',
      shipDate: null,
      shipNote: 'Datum nicht festgelegt',
      discountNote: 'Kein Rabatt angewendet',
      comment: 'Handelsangebot für Zubehör vorbereiten.',
      items: [
        { sku: 'VP-3010', name: 'Bremsbelag-Set', qty: 12, price: 180 },
        { sku: 'VP-5520', name: 'Performance Scheiben-Set', qty: 6, price: 440 },
      ],
      history: [
        { when: '24.09 · 09:40 · Sales', note: 'Anfrage für aktualisierte Preisliste erhalten.' },
        { when: '22.09 · 11:30 · Sales', note: 'Bestellung erstellt, Spezifikation wird abgestimmt.' },
      ],
    },
    {
      id: 'ORD-9120',
      state: 'NEW',
      clientName: 'VeloParts',
      clientContact: 'Kontakt: Christina Roche · +41 22 555 12 12',
      ownerName: 'Igor Kowalew',
      ownerRole: 'Sales',
      paymentStatus: 'Zahlung: nicht eingegangen',
      shipDate: null,
      shipNote: 'Termin nicht festgelegt',
      discountNote: 'Kein Rabatt',
      comment: 'Warten auf Bestätigung zur Eillieferung.',
      items: [
        { sku: 'VP-2205', name: 'Zahnriemen-Set', qty: 7, price: 300 },
      ],
      history: [
        { when: '23.09 · 15:15 · Sales', note: 'Eilzustellungskosten aktualisiert.' },
        { when: '23.09 · 10:02 · Sales', note: 'Positionen auf Kundenwunsch eingefügt.' },
      ],
    },
    {
      id: 'ORD-8745',
      state: 'APPROVAL',
      clientName: 'OOO «Altair Industries»',
      clientContact: 'Kontakt: Irina Sokolova · +48 600 333 11',
      ownerName: 'Anna Petrowa',
      ownerRole: 'Sales',
      paymentStatus: 'Zahlung: nicht eingegangen',
      shipDate: '28.09.2025',
      shipNote: 'Klärt Logistik ab',
      discountNote: 'Kein Rabatt',
      comment: 'Kunde wünscht beschleunigte Lieferung.',
      items: [
        { sku: 'AL-4820', name: 'Bremsscheiben-Set (vorn)', qty: 2, price: 2450 },
        { sku: 'AL-5112', name: 'Performance-Belagsatz', qty: 2, price: 1680 },
        { sku: 'AL-9630', name: 'Stoßdämpfer verstärkt', qty: 2, price: 2140 },
      ],
      history: [
        { when: '25.09 · 17:42 · Sales', note: 'Kunde hat Eillieferung zugestimmt, warten auf Zahlung.' },
        { when: '25.09 · 09:05 · Sales', note: 'ORD-8745 angelegt und zur Bestätigung an Manager weitergeleitet.' },
      ],
    },
    {
      id: 'ORD-8742',
      state: 'PICKING',
      clientName: 'Nova Parts',
      clientContact: 'Kontakt: Tomasz Grzib · +48 501 777 12',
      ownerName: 'Wladimir Orlow',
      ownerRole: 'Sales',
      paymentStatus: 'Zahlung: erwartet Bestätigung',
      shipDate: null,
      shipNote: 'Lagerkommissionierung',
      discountNote: 'Rabatt 3% nach Versand',
      comment: 'Logistik klärt Verpackung.',
      items: [
        { sku: 'NP-7201', name: 'Spurstangen-Set', qty: 4, price: 680 },
        { sku: 'NP-1800', name: 'Stoßdämpfer verstärkt', qty: 8, price: 560 },
        { sku: 'NP-9900', name: 'Motorlager', qty: 2, price: 560 },
      ],
      history: [
        { when: '25.09 · 13:12 · Logistics', note: 'Warten auf Bestätigung Verpackungsverfügbarkeit.' },
        { when: '24.09 · 18:45 · Sales', note: 'Zahlungsbestätigung 50% erhalten.' },
      ],
    },
    {
      id: 'ORD-8738',
      state: 'READY',
      clientName: 'Nova Cars',
      clientContact: 'Kontakt: Janine Bosch · +41 44 883 10 84',
      ownerName: 'Anna Petrowa',
      ownerRole: 'Sales',
      paymentStatus: 'Zahlung: eingegangen',
      shipDate: '26.09.2025',
      shipNote: 'Bereit zur Ausgabe',
      discountNote: 'Rabatt 5% gewährt',
      comment: 'Warten auf Kundenabholung.',
      items: [
        { sku: 'NC-4400', name: 'Ultimate-Bremsanlage', qty: 8, price: 320 },
        { sku: 'NC-8820', name: 'Kühlsystem komplett', qty: 4, price: 760 },
      ],
      history: [
        { when: '26.09 · 09:20 · Sales', note: 'Versand vereinbart, warten auf Transport.' },
        { when: '25.09 · 16:05 · Finance', note: 'Zahlung vollständig eingegangen.' },
      ],
    },
    {
      id: 'ORD-8722',
      state: 'CLOSED',
      clientName: 'AutoHub',
      clientContact: 'Kontakt: Mateusz Nowak · +48 602 110 45',
      ownerName: 'Wladimir Orlow',
      ownerRole: 'Sales',
      paymentStatus: 'Zahlung: eingegangen',
      shipDate: '18.09.2025',
      shipNote: 'Versendet',
      discountNote: 'Rabatt 2% vereinbart',
      comment: 'Abgeschlossen ohne Abweichungen.',
      items: [
        { sku: 'AH-3300', name: 'Kupplungs-Set', qty: 5, price: 350 },
        { sku: 'AH-9020', name: 'Getriebe generalüberholt', qty: 5, price: 440 },
      ],
      history: [
        { when: '19.09 · 12:10 · Logistics', note: 'Auftrag geschlossen, Dokumente versendet.' },
        { when: '18.09 · 08:55 · Sales', note: 'Kunde hat Warenempfang bestätigt.' },
      ],
    },
  ];


  const STATUS_MAP = {
    NEW: 'Offen',
    APPROVAL: 'In Arbeit',
    PICKING: 'In Arbeit',
    READY: 'In Arbeit',
    CLOSED: 'Geschlossen',
  };
  const deriveStatus = state => STATUS_MAP[state] || 'Offen';

  const formatCurrencyCHF = value => `${(Number(value) || 0).toLocaleString('de-CH')} CHF`;
  const calculateItemsTotal = items => items.reduce((sum, item) => {
    const qty = Number(item.qty) || 0;
    const price = Number(item.price) || 0;
    return sum + qty * price;
  }, 0);

  orders.forEach(order => {
    order.items = order.items || [];
    order.history = order.history || [];
    order.amount = calculateItemsTotal(order.items);
    order.status = deriveStatus(order.state);
    const historyEntry = order.history[order.history.length - 1] || order.history[0] || null;
    order.createdLabel = extractDateLabel(historyEntry?.when);
  });

  const clients = [
    {
      id: "client-veloparts",
      name: "VeloParts",
      sourceName: "VeloParts",
      phone: "+41 22 555 12 12",
      email: "sales@veloparts.ch",
      status: "Aktiv",
      owner: "Anna Sawitzka",
      createdAt: "12.05.2024",
      address: "Genf, Route de Meyrin 210",
      notes: "Schlüsselkunde für Fahrradkomponenten, hohes Volumen von Folgeaufträgen.",
    },
    {
      id: "client-altair",
      name: "OOO «Altair Industries»",
      sourceName: "OOO «Altair Industries»",
      phone: "+48 600 333 11",
      email: "procurement@altair-industries.pl",
      status: "In Abstimmung",
      owner: "Alexey Gromow",
      createdAt: "18.08.2024",
      address: "Polen, Warschau, ul. Przemysłowa 12",
      notes: "Fordern individuelle Rabatte und flexiblen Lieferplan.",
    },
    {
      id: "client-novaparts",
      name: "Nova Parts",
      sourceName: "Nova Parts",
      phone: "+48 501 777 12",
      email: "supply@novaparts.pl",
      status: "Aktiv",
      owner: "Dmitri Chen",
      createdAt: "02.04.2024",
      address: "Polen, Łódź, Piotrkowska 220",
      notes: "Regelmäßige Lieferungen nach Plan, achten genau auf Termine.",
    },
    {
      id: "client-novacars",
      name: "Nova Cars",
      sourceName: "Nova Cars",
      phone: "+41 44 883 10 84",
      email: "purchasing@novacars.ch",
      status: "Aktiv",
      owner: "Marina Kowal",
      createdAt: "09.06.2024",
      address: "Schweiz, Zürich, Förrlibuckstrasse 45",
      notes: "Wechseln zu Vorauszahlung, erwarten Sortimentserweiterung.",
    },
    {
      id: "client-autohub",
      name: "AutoHub",
      sourceName: "AutoHub",
      phone: "+48 602 110 45",
      email: "orders@autohub.pl",
      status: "Geschlossen",
      owner: "Danila Rossomakha",
      createdAt: "15.02.2024",
      address: "Polen, Krakau, Aleja Jana Pawła II 78",
      notes: "Projekt geschlossen, besprechen Serviceverträge.",
    },
  ];
  const getClientLookupKey = client => (client?.sourceName || client?.name || '').trim();

  const getClientOrdersSnapshot = client => {
    const key = getClientLookupKey(client);
    return orders
      .filter(order => key === (order.clientName || '').trim())
      .map(order => {
        const stateInfo = STATE_LOOKUP[order.state] || {};
        return {
          id: order.id,
          date: order.createdLabel,
          amount: formatCurrencyCHF(order.amount),
          state: stateInfo.title || order.state,
          status: order.status || deriveStatus(order.state),
          payment: order.paymentStatus || '—',
          shipment: order.shipDate || order.shipNote || '—',
        };
      });
  };

  if (!activeClientId && clients.length) {
    activeClientId = clients[0].id;
  }



  let activeOrderId = detailPanel?.dataset.order || (orders[0]?.id ?? null);
  let draggedOrderId = null;
  let loadOrderDetail = () => {};

  const applyWorkspaceMode = mode => {
    if (!kanbanView || !listView) {
      return;
    }
    if (workspaceTop) {
      workspaceTop.dataset.mode = mode;
    }
    viewTabs.forEach(tab => {
      tab.classList.toggle('is-active', tab.dataset.mode === mode);
    });
    if (mode === 'list') {
      kanbanView.style.display = 'none';
      listView.style.display = 'block';
    } else {
      kanbanView.style.display = 'grid';
      listView.style.display = 'none';
    }
  };

  viewTabs.forEach(tab => {
    tab.addEventListener('click', () => {
      const mode = tab.dataset.mode;
      applyWorkspaceMode(mode);
    });
  });

  mainTabs.forEach(tab => {
    tab.addEventListener('click', () => {
      applyMainView(tab.dataset.view);
    });
  });

  const findClient = id => clients.find(client => client.id === id);

  const findClientByName = name => clients.find(client => getClientLookupKey(client) === (name || '').trim());

  const applyMainView = view => {
    if (!workspaceTop || !workspaceBottom) {
      return;
    }
    activeMainView = view;
    workspaceTop.dataset.view = view;
    workspaceBottom.dataset.view = view;
    if (ordersWorkspace) {
      ordersWorkspace.style.display = view === 'orders' ? 'grid' : 'none';
    }
    if (clientsWorkspace) {
      clientsWorkspace.style.display = view === 'clients' ? 'block' : 'none';
    }
    if (ordersActions) {
      ordersActions.style.display = view === 'orders' ? 'flex' : 'none';
    }
    if (clientsActions) {
      clientsActions.style.display = view === 'clients' ? 'flex' : 'none';
    }
    if (viewTabsContainer) {
      viewTabsContainer.style.display = view === 'orders' ? 'inline-flex' : 'none';
    }
    mainTabs.forEach(tab => {
      tab.classList.toggle('is-active', tab.dataset.view === view);
    });
    if (view === 'orders') {
      applyWorkspaceMode(workspaceTop.dataset.mode || 'kanban');
    } else {
      renderClientsTable();
      if (activeClientId) {
        loadClientDetail(findClient(activeClientId));
      }
    }
  };

  function renderClientsTable() {
    if (!clientsTableBody) {
      return;
    }
    clientsTableBody.innerHTML = '';
    clients.forEach(client => {
      const row = document.createElement('tr');
      row.dataset.client = client.id;
      row.innerHTML = `
        <td>${client.name}</td>
        <td>${client.phone}</td>
        <td>${client.email}</td>
        <td>${client.status}</td>
        <td>${client.owner}</td>
      `;
      if (client.id === activeClientId) {
        row.classList.add('is-active');
      }
      row.addEventListener('click', () => {
        activeClientId = client.id;
        clientsTableBody.querySelectorAll('tr').forEach(tr => tr.classList.remove('is-active'));
        row.classList.add('is-active');
        loadClientDetail(client);
      });
      clientsTableBody.appendChild(row);
    });
  }

  function loadClientDetail(client) {
    if (!client) {
      return;
    }
    if (clientDetailName) {
      clientDetailName.textContent = client.name || '—';
    }
    if (clientStatusChip) {
      clientStatusChip.textContent = client.status || '—';
    }
    if (clientOwnerChip) {
      clientOwnerChip.textContent = client.owner ? `Verantwortlich: ${client.owner}` : 'Verantwortlich nicht zugeordnet';
    }
    if (clientDetailPhone) {
      clientDetailPhone.textContent = client.phone || '—';
    }
    if (clientDetailEmail) {
      clientDetailEmail.textContent = client.email || '—';
    }
    if (clientDetailAddress) {
      clientDetailAddress.textContent = client.address || '—';
    }
    if (clientDetailCreated) {
      clientDetailCreated.textContent = client.createdAt || '—';
    }
    if (clientDetailOwner) {
      clientDetailOwner.textContent = client.owner || '—';
    }
    if (clientDetailNotes) {
      clientDetailNotes.textContent = client.notes || '—';
    }
    if (clientOrdersBody) {
      clientOrdersBody.innerHTML = '';
      const sourceOrders = getClientOrdersSnapshot(client);
      if (!sourceOrders.length) {
        const emptyRow = document.createElement('tr');
        const emptyCell = document.createElement('td');
        emptyCell.colSpan = 6;
        emptyCell.textContent = 'Keine Bestellungen';
        emptyRow.appendChild(emptyCell);
        clientOrdersBody.appendChild(emptyRow);
      } else {
        sourceOrders.forEach(order => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${order.id}</td>
            <td>${order.date}</td>
            <td>${order.amount}</td>
            <td>${order.state}</td>
            <td>${order.status}</td>
            <td>${order.payment}</td>
            <td>${order.shipment}</td>
          `;
          row.addEventListener('click', () => {
            applyMainView('orders');
            setActiveOrder(order.id);
          });
          clientOrdersBody.appendChild(row);
        });
      }
    }
  }
  const clearDropHighlights = () => {
    document.querySelectorAll('.kanban-column.is-drop-target').forEach(column => column.classList.remove('is-drop-target'));
  };

  const getOrdersByState = stateId => orders.filter(order => order.state === stateId);
  const findOrderRecord = id => orders.find(order => order.id === id);

  const applyOrderState = (orderId, newState) => {
    const order = findOrderRecord(orderId);
    if (!order || order.state === newState) {
      return false;
    }
    order.state = newState;
    order.status = deriveStatus(newState);
    return true;
  };

  function renderKanban() {
    if (!kanbanView) {
      return;
    }
    kanbanView.innerHTML = '';
    STATE_FLOW.forEach(state => {
      const column = document.createElement('article');
      column.className = `kanban-column ${state.columnClass}`;
      column.dataset.state = state.id;

      const header = document.createElement('header');
      const title = document.createElement('h3');
      title.textContent = state.title;
      const count = document.createElement('span');
      count.className = 'kanban-count';

      header.appendChild(title);
      header.appendChild(count);
      column.appendChild(header);

      const cardsWrap = document.createElement('div');
      cardsWrap.className = 'kanban-cards';
      const columnOrders = getOrdersByState(state.id);
      count.textContent = columnOrders.length;
      columnOrders.forEach(order => {
        cardsWrap.appendChild(buildKanbanCard(order));
      });
      column.appendChild(cardsWrap);
      attachColumnDnD(column);
      kanbanView.appendChild(column);
    });
  }

  function renderList() {
    if (!listView) {
      return;
    }
    const table = document.createElement('table');
    const thead = document.createElement('thead');
    thead.innerHTML = `
      <tr>
        <th>Bestellung</th>
        <th>Kunde</th>
        <th>Status</th>
        <th>Versand</th>
        <th>Betrag</th>
      </tr>
    `;
    const tbody = document.createElement('tbody');
    orders.forEach(order => {
      const row = document.createElement('tr');
      row.dataset.order = order.id;
      row.dataset.state = order.state.toLowerCase();
      if (order.id === activeOrderId) {
        row.classList.add('is-active');
      }
      const stateInfo = STATE_LOOKUP[order.state];
      const stateLabel = stateInfo ? stateInfo.listLabel : order.state;
      const shipLabel = order.shipDate || (order.shipNote || '—');
      row.innerHTML = `
        <td>${order.id}</td>
        <td>${order.clientName}</td>
        <td>${stateLabel}</td>
        <td>${shipLabel}</td>
        <td>${formatCurrencyCHF(order.amount)}</td>
      `;
      row.addEventListener('click', () => setActiveOrder(order.id));
      tbody.appendChild(row);
    });
    table.appendChild(thead);
    table.appendChild(tbody);
    listView.innerHTML = '';
    listView.appendChild(table);
  }

  function refreshWorkspace() {
    renderKanban();
    renderList();
  }

  function setActiveOrder(orderId, options = {}) {
    const order = findOrderRecord(orderId);
    if (!order) {
      return;
    }
    const { suppressRefresh = false } = options;
    activeOrderId = orderId;
    loadOrderDetail(order);
    if (!suppressRefresh) {
      refreshWorkspace();
    }
  }

  function buildKanbanCard(order) {
    const card = document.createElement('div');
    card.className = 'kanban-card';
    if (order.id === activeOrderId) {
      card.classList.add('is-active');
    }
    card.dataset.order = order.id;
    card.dataset.state = order.state;
    card.draggable = true;
    card.innerHTML = `
      <span class="card-title"><strong>${order.id}</strong><span class="card-amount">· ${formatCurrencyCHF(order.amount)}</span></span>
      <div class="pill-row">
        <span class="pill">Kunde: ${order.clientName}</span>
      </div>
    `;
    card.addEventListener('click', () => setActiveOrder(order.id));
    card.addEventListener('dragstart', event => {
      draggedOrderId = order.id;
      card.classList.add('dragging');
      if (event.dataTransfer) {
        event.dataTransfer.effectAllowed = 'move';
        event.dataTransfer.setData('text/plain', order.id);
      }
      setActiveOrder(order.id, { suppressRefresh: true });
    });
    card.addEventListener('dragend', () => {
      draggedOrderId = null;
      card.classList.remove('dragging');
      clearDropHighlights();
    });
    return card;
  }

  const handleDragOver = event => {
    if (!draggedOrderId) {
      return;
    }
    event.preventDefault();
    if (event.dataTransfer) {
      event.dataTransfer.dropEffect = 'move';
    }
    event.currentTarget.classList.add('is-drop-target');
  };

  const handleDragEnter = event => {
    if (!draggedOrderId) {
      return;
    }
    event.preventDefault();
    event.currentTarget.classList.add('is-drop-target');
  };

  const handleDragLeave = event => {
    if (!draggedOrderId) {
      return;
    }
    const column = event.currentTarget;
    if (event.relatedTarget && column.contains(event.relatedTarget)) {
      return;
    }
    column.classList.remove('is-drop-target');
  };

  const handleDrop = event => {
    event.preventDefault();
    const column = event.currentTarget;
    column.classList.remove('is-drop-target');
    const orderId = draggedOrderId || (event.dataTransfer ? event.dataTransfer.getData('text/plain') : null);
    draggedOrderId = null;
    clearDropHighlights();
    if (!orderId) {
      return;
    }
    const changed = updateBoardForState(orderId, column.dataset.state, { source: 'board', suppressRefresh: true });
    if (changed) {
      setActiveOrder(orderId);
    }
  };

  function attachColumnDnD(column) {
    column.addEventListener('dragover', handleDragOver);
    column.addEventListener('dragenter', handleDragEnter);
    column.addEventListener('dragleave', handleDragLeave);
    column.addEventListener('drop', handleDrop);
  }

  function updateBoardForState(orderId, newState, { source = 'board', emitEvent = true, suppressRefresh = false } = {}) {
    if (!applyOrderState(orderId, newState)) {
      return false;
    }
    if (!suppressRefresh) {
      refreshWorkspace();
    }
    if (emitEvent) {
      document.dispatchEvent(new CustomEvent('order:state-changed', {
        detail: { orderId, state: newState, source },
      }));
    }
    return true;
  }

  document.addEventListener('order:state-changed', event => {
    const payload = event.detail || {};
    if (!payload.orderId || !payload.state || payload.source === 'board') {
      return;
    }
    updateBoardForState(payload.orderId, payload.state, { emitEvent: false });
  });

  if (detailPanel) {
    const editBtn = detailPanel.querySelector('[data-action="edit"]');
    const saveBtn = detailPanel.querySelector('[data-action="save"]');
    const cancelBtn = detailPanel.querySelector('[data-action="cancel"]');

    const progressSteps = Array.from(detailPanel.querySelectorAll('.progress-step'));
    const statusChip = detailPanel.querySelector('#statusChip');
    const stateLabelView = detailPanel.querySelector('#stateLabelView');
    const stateNextView = detailPanel.querySelector('#stateNextView');
    const orderAmountView = detailPanel.querySelector('#orderAmountView');
    const orderAmountEdit = detailPanel.querySelector('#orderAmountEdit');
    const itemsViewBody = detailPanel.querySelector('#itemsViewBody');
    const itemsEditBody = detailPanel.querySelector('#itemsEditBody');
    const addItemBtn = detailPanel.querySelector('#addItemBtn');
    const detailOrderTitle = detailPanel.querySelector('#detailOrderTitle');
    const paymentChip = detailPanel.querySelector('#paymentChip');
    const shipChip = detailPanel.querySelector('#shipChip');
    const detailClientName = detailPanel.querySelector('#detailClientName');
    const detailClientContact = detailPanel.querySelector('#detailClientContact');
    const detailOwnerName = detailPanel.querySelector('#detailOwnerName');
    const detailOwnerRole = detailPanel.querySelector('#detailOwnerRole');
    const detailDiscountNote = detailPanel.querySelector('#detailDiscountNote');
    const commentField = detailPanel.querySelector('#comment');
    const timelineList = detailPanel.querySelector('#timelineList');
    const clientSummaryCard = detailPanel.querySelector('[data-role="client-summary"]');

    const copyItem = item => ({ ...item });

    const itemRows = [];

    let currentOrderRecord = findOrderRecord(detailPanel.dataset.order);
    let persistedItems = currentOrderRecord ? currentOrderRecord.items.map(copyItem) : [];
    let workingItems = persistedItems.map(copyItem);
    let persistedState = currentOrderRecord ? currentOrderRecord.state : (STATE_FLOW[0]?.id || 'NEW');
    let draftState = persistedState;

    if (clientSummaryCard) {
      clientSummaryCard.addEventListener('click', () => {
        if (!currentOrderRecord) {
          return;
        }
        const linkedClient = findClientByName(currentOrderRecord.clientName);
        if (!linkedClient) {
          return;
        }
        activeClientId = linkedClient.id;
        applyMainView('clients');
      });
    }

    const parseNumber = value => {
      const numeric = Number(value);
      return Number.isFinite(numeric) ? numeric : 0;
    };

    const formatNumber = value => {
      const normalized = Number.isFinite(value) ? value : 0;
      if (Number.isInteger(normalized)) {
        return normalized.toLocaleString('de-CH');
      }
      return normalized.toLocaleString('de-CH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    };

    const getStepByState = state => progressSteps.find(step => step.dataset.state === state) || progressSteps[0];

    const applyStateVisual = state => {
      const targetStep = getStepByState(state);
      const targetIndex = Number(targetStep.dataset.step);

      progressSteps.forEach(step => {
        const stepIndex = Number(step.dataset.step);
        step.classList.remove('is-current', 'is-done');
        if (stepIndex < targetIndex) {
          step.classList.add('is-done');
        } else if (stepIndex === targetIndex) {
          step.classList.add('is-current');
        }
      });

      const label = targetStep.textContent.trim();
      const nextStep = progressSteps.find(step => Number(step.dataset.step) === targetIndex + 1);
      const nextLabelView = nextStep ? `Nächster Schritt: ${nextStep.textContent.trim()}` : 'Phase abgeschlossen';

      if (statusChip) {
        const statusText = deriveStatus(state);
        statusChip.textContent = `Status: ${statusText}`;
      }
      if (stateLabelView) {
        stateLabelView.textContent = label;
      }
      if (stateNextView) {
        stateNextView.textContent = nextLabelView;
      }
      detailPanel.dataset.state = state;
    };

    progressSteps.forEach(step => {
      step.addEventListener('click', () => {
        if (detailPanel.dataset.mode !== 'edit') {
          return;
        }
        draftState = step.dataset.state;
        applyStateVisual(draftState);
      });
    });

    const clearItemsTable = () => {
      itemRows.length = 0;
      if (itemsViewBody) {
        itemsViewBody.innerHTML = '';
      }
      if (itemsEditBody) {
        itemsEditBody.innerHTML = '';
      }
    };

    const updateViewRow = rowObj => {
      const { item, viewCells } = rowObj;
      viewCells.sku.textContent = item.sku || '—';
      viewCells.name.textContent = item.name || '—';
      viewCells.qty.textContent = formatNumber(item.qty || 0);
      viewCells.price.textContent = formatNumber(item.price || 0);
      viewCells.sum.textContent = formatNumber((item.qty || 0) * (item.price || 0));
    };

    const updateTotals = () => {
      const total = workingItems.reduce((acc, item) => acc + (item.qty || 0) * (item.price || 0), 0);
      if (orderAmountView) {
        orderAmountView.textContent = `${formatNumber(total)} CHF`;
      }
      if (orderAmountEdit) {
        orderAmountEdit.textContent = `${formatNumber(total)} CHF`;
      }
      if (currentOrderRecord) {
        currentOrderRecord.amount = total;
      }
    };

    const updateRow = rowObj => {
      const sum = (rowObj.item.qty || 0) * (rowObj.item.price || 0);
      rowObj.sumDisplay.textContent = formatNumber(sum);
      updateViewRow(rowObj);
      updateTotals();
    };

    const appendItemRow = item => {
      if (!itemsViewBody || !itemsEditBody) {
        return null;
      }

      const viewRow = document.createElement('tr');
      viewRow.innerHTML = `
        <td data-role="sku"></td>
        <td data-role="name"></td>
        <td data-role="qty"></td>
        <td data-role="price"></td>
        <td data-role="sum"></td>
      `;
      itemsViewBody.appendChild(viewRow);

      const editRow = document.createElement('tr');
      editRow.innerHTML = `
        <td><input data-field="sku" value="${item.sku || ''}"></td>
        <td><input data-field="name" value="${item.name || ''}"></td>
        <td><input data-field="qty" type="number" min="0" step="1" value="${item.qty ?? 0}"></td>
        <td><input data-field="price" type="number" min="0" step="0.01" value="${item.price ?? 0}"></td>
        <td class="sum-cell"><span class="sum-display" data-role="row-sum"></span></td>
      `;
      itemsEditBody.appendChild(editRow);

      const rowObj = {
        item,
        viewCells: {
          sku: viewRow.querySelector('[data-role="sku"]'),
          name: viewRow.querySelector('[data-role="name"]'),
          qty: viewRow.querySelector('[data-role="qty"]'),
          price: viewRow.querySelector('[data-role="price"]'),
          sum: viewRow.querySelector('[data-role="sum"]'),
        },
        sumDisplay: editRow.querySelector('[data-role="row-sum"]'),
        inputs: {
          sku: editRow.querySelector('[data-field="sku"]'),
          name: editRow.querySelector('[data-field="name"]'),
          qty: editRow.querySelector('[data-field="qty"]'),
          price: editRow.querySelector('[data-field="price"]'),
        },
      };

      rowObj.inputs.sku.addEventListener('input', event => {
        rowObj.item.sku = event.target.value;
        updateViewRow(rowObj);
      });

      rowObj.inputs.name.addEventListener('input', event => {
        rowObj.item.name = event.target.value;
        updateViewRow(rowObj);
      });

      rowObj.inputs.qty.addEventListener('input', () => {
        rowObj.item.qty = Math.max(0, parseNumber(rowObj.inputs.qty.value));
        updateRow(rowObj);
      });

      rowObj.inputs.price.addEventListener('input', () => {
        rowObj.item.price = Math.max(0, parseNumber(rowObj.inputs.price.value));
        updateRow(rowObj);
      });

      itemRows.push(rowObj);
      updateRow(rowObj);
      return rowObj;
    };

    const rebuildItemsTable = () => {
      clearItemsTable();
      workingItems.forEach(appendItemRow);
      updateTotals();
    };

    if (addItemBtn) {
      addItemBtn.addEventListener('click', () => {
        if (detailPanel.dataset.mode !== 'edit') {
          return;
        }
        const newItem = { sku: '', name: '', qty: 1, price: 0 };
        workingItems.push(newItem);
        const newRow = appendItemRow(newItem);
        if (newRow?.inputs?.sku) {
          requestAnimationFrame(() => newRow.inputs.sku.focus());
        }
      });
    }

    const setDetailMode = mode => {
      detailPanel.dataset.mode = mode;
      if (mode === 'edit') {
        workingItems = persistedItems.map(copyItem);
        draftState = persistedState;
      } else {
        workingItems = persistedItems.map(copyItem);
        draftState = persistedState;
      }
      rebuildItemsTable();
      applyStateVisual(mode === 'edit' ? draftState : persistedState);
    };

    function updateTimeline(history) {
      if (!timelineList) {
        return;
      }
      timelineList.innerHTML = '';
      if (!history.length) {
        const entry = document.createElement('div');
        entry.className = 'timeline-entry';
        const note = document.createElement('p');
        note.textContent = 'Historie noch leer.';
        entry.appendChild(note);
        timelineList.appendChild(entry);
        return;
      }
      history.forEach(item => {
        const entry = document.createElement('div');
        entry.className = 'timeline-entry';
        const time = document.createElement('time');
        time.textContent = item.when;
        const note = document.createElement('p');
        note.textContent = item.note;
        entry.appendChild(time);
        entry.appendChild(note);
        timelineList.appendChild(entry);
      });
    }

    const loadOrder = order => {
      if (!order) {
        return;
      }
      order.status = deriveStatus(order.state);
      currentOrderRecord = order;
      detailPanel.dataset.order = order.id;
      detailPanel.dataset.state = order.state;

      if (detailOrderTitle) {
        detailOrderTitle.textContent = `${order.id} · Bestelldetails`;
      }
      if (paymentChip) {
        paymentChip.textContent = order.paymentStatus || 'Zahlung: —';
      }
      if (shipChip) {
        const shipLabel = order.shipDate ? `Versand: ${order.shipDate}` : `Versand: ${order.shipNote || '—'}`;
        shipChip.textContent = shipLabel;
      }
      if (detailClientName) {
        detailClientName.textContent = order.clientName;
      }
      if (detailClientContact) {
        detailClientContact.textContent = order.clientContact || '—';
      }
      if (detailOwnerName) {
        detailOwnerName.textContent = order.ownerName || '—';
      }
      if (detailOwnerRole) {
        detailOwnerRole.textContent = order.ownerRole ? `Rolle: ${order.ownerRole}` : '';
      }
      if (detailDiscountNote) {
        detailDiscountNote.textContent = order.discountNote || '';
      }
      if (commentField) {
        commentField.value = order.comment || '';
      }
      updateTimeline(order.history || []);

      persistedItems = (order.items || []).map(copyItem);
      workingItems = persistedItems.map(copyItem);
      persistedState = order.state;
      draftState = order.state;
      order.amount = calculateItemsTotal(order.items || []);

      if (detailPanel.dataset.mode === 'edit') {
        setDetailMode('view');
      } else {
        rebuildItemsTable();
        applyStateVisual(order.state);
      }
      updateTotals();
    };

    loadOrderDetail = loadOrder;

    if (editBtn) {
      editBtn.addEventListener('click', () => setDetailMode('edit'));
    }

    if (cancelBtn) {
      cancelBtn.addEventListener('click', () => setDetailMode('view'));
    }

    if (saveBtn) {
      saveBtn.addEventListener('click', () => {
        persistedState = draftState;
        persistedItems = workingItems.map(copyItem);
        if (currentOrderRecord) {
          currentOrderRecord.items = persistedItems.map(copyItem);
          currentOrderRecord.amount = calculateItemsTotal(persistedItems);
          currentOrderRecord.state = persistedState;
        }
        console.log('Mock save', {
          state: persistedState,
          items: persistedItems,
        });
        document.dispatchEvent(new CustomEvent('order:state-changed', {
          detail: {
            orderId: detailPanel.dataset.order,
            state: persistedState,
            source: 'detail',
          },
        }));
        setDetailMode('view');
      });
    }

    document.addEventListener('order:state-changed', event => {
      const payload = event.detail || {};
      if (!payload.orderId || payload.orderId !== detailPanel.dataset.order || payload.source === 'detail') {
        return;
      }
      persistedState = payload.state;
      draftState = payload.state;
      if (currentOrderRecord) {
        currentOrderRecord.state = payload.state;
      }
      applyStateVisual(payload.state);
    });
  }

  const initialOrder = findOrderRecord(activeOrderId) || orders[0];
  if (initialOrder) {
    activeOrderId = initialOrder.id;
    loadOrderDetail(initialOrder);
  }
  refreshWorkspace();
  renderClientsTable();
  if (activeClientId) {
    loadClientDetail(findClient(activeClientId));
  }
  applyMainView(activeMainView);
</script>
</body>
</html>











































