# Процесс: сопровождение заказа (Sales Workspace MVP)

Документ детализирует шаги целевого процесса, отображаемого в рабочем месте продаж. Основой служит модель состояний и ролей из бизнес-требований.

## 1. Стартовые условия
- Есть клиент (запись в `Kontakt`).
- Sales авторизован в Exolynk и работает в workspace «Sales». 

## 2. Основной поток
1. **Создание заказа (Sales)**
   - Sales создаёт запись `Order` в состоянии `NEW`.
   - Вносит позиции `OrderItem`, комментарии, плановую дату отгрузки.
   - При сумме >10 000 CHF система помечает заказ для менеджера.
2. **Передача на утверждение (Sales)**
   - Sales переводит заказ в `APPROVAL`.
   - Уходит уведомление `svc_notify_manager_approval`.
3. **Утверждение (Manager)**
   - Проверяет данные, может:
     - Утвердить (`APPROVAL → PICKING`).
     - Вернуть в `NEW` с комментариями.
     - Закрыть / отказать (неуспешно) с указанием причины.
4. **Комплектация (Logistics)**
   - В состоянии `PICKING` логистика проверяет наличие, комплектует.
   - При готовности переводит в `READY`, фиксирует `shipment_state=READY` и дату отгрузки.
   - Отправляется уведомление `svc_notify_manager_payment`.
5. **Оплата и закрытие (Manager)**
   - Подтверждает оплату (`payment_state=YES`).
   - Переводит в `CLOSED`, `closed_success=true`.
6. **Альтернатива:** Sales может закрыть заказ как неуспешный из любого открытого состояния (`CLOSED`, `closed_success=false`, `close_reason=*`).

## 3. Дополнительные сценарии
- **Автоматическое завершение отгрузки:** системный сервис устанавливает `shipment_state=SHIPPED` после получения подтверждения.
- **История состояний:** фиксируется системным аудитом Exolynk (доп. таблица не заводится).

## 4. Переходы состояний (кратко)
```
NEW --(Sales)--> APPROVAL --(Manager)--> PICKING --(Logistics)--> READY --(Manager)--> CLOSED(success)
     \--(Sales)--> CLOSED(fail)
```

## 5. Используемые уведомления (концепт)
- `svc_notify_manager_approval`
- `svc_notify_logistics_picking`
- `svc_notify_manager_payment`
- `svc_close_success`

## 6. Связанные артефакты
- Диаграммы процесса: `diagrams/plantuml/` (будут добавлены).
- UI прототип: `ui/exolynk_sales_workspace.html`.
- Требования: `docs/requirements/business_requirements.md`.
