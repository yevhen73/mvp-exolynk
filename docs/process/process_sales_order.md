# Процесс: сопровождение заказа (Sales Workspace MVP)

Документ описывает, как проходит заказ через продажи, логистику и контроль менеджера в рамках MVP.

## Роли и ответственность
- **Продавец (Sales)** — создаёт заказ, наполняет карточку, при необходимости закрывает сделку как неуспешную с указанием причины.
- **Логист (Logistics)** — выполняет комплектацию и передаёт заказ клиенту.
- **Менеджер (Manager)** — контролирует этап запуска комплектации и факт оплаты; получает отчётность.
- **Система (Exolynk)** — применяет бизнес-правила, переводит заказ между состояниями и отправляет задачи/уведомления.

## Основной поток
1. **Создание заказа (Sales)**
   - Продавец заводит запись `Order`: система автоматически присваивает состояние `NEW`, проставляет текущие даты и инициализирует флаги.
   - Продавец добавляет позиции `OrderItem`, комментарии и прочую информацию.
2. **Контроль бизнес-правил (System)**
   - После сохранения система проверяет пороговые условия (например, сумма > 10 000 CHF).
   - Если правило срабатывает — заказ переводится в `APPROVAL`, менеджеру уходит уведомление `svc_notify_manager_approval`.
   - Если дополнительных проверок нет — система сразу разрешает комплектацию и переводит заказ в `PICKING`.
3. **Разрешение на комплектацию (Manager)**
   - Менеджер рассматривает заказы в `APPROVAL` и подтверждает запуск комплектации.
   - При подтверждении система переводит заказ в `PICKING` и уведомляет логистику (`svc_notify_logistics_picking`).
4. **Комплектация и выдача (Logistics)**
   - Логист работает с заказом в `PICKING`.
   - Когда заказ готов к выдаче, логист переводит его в `READY`; система фиксирует текущую дату как дату готовности и запускает контроль оплаты (`svc_notify_manager_payment`).
5. **Контроль оплаты (Manager)**
   - Менеджер проверяет оплату и устанавливает флаг `payment_state=YES`.
   - Как только флаг установлен, система автоматически переводит заказ в состояние `CLOSED`, отмечая его как успешно выполненный (`closed_success=true`).

### Альтернативный сценарий
- Продавец вправе завершить сделку как неуспешную из любого «открытого» состояния (`closed_success=false` + `close_reason=*`). В этом случае заказ также переходит в `CLOSED`, но помечается как «Закрыто (неуспешно)».

## Дополнительные заметки
- Продавец и логист не вводят даты вручную — система проставляет актуальную дату перехода.
- Уведомления и задачи реализуются через сервисы Exolynk (`svc_notify_*`).
- История переходов опирается на встроенный аудит платформы.

## Статусы и отображение
- Канбан построен на `state`: `NEW`, `APPROVAL`, `PICKING`, `READY`, `CLOSED`.
- Колонка `CLOSED` остаётся единой. Успешные и неуспешные заказы различаются визуально (значок, перечёркнутый текст и т.п. — требуется доработка UI), при этом оба вида имеют `status=CLOSED`.
- Агрегированный `status` (`OPEN`, `EXECUTION`, `CLOSED`) служит для фильтров и отчётности.

## Связанные артефакты
- `docs/requirements/business_requirements.md` — бизнес-требования.
- `docs/tech/tech_stack.md` — описание платформы и интеграций.
- `diagrams/plantuml/` — процессные диаграммы (добавляются по мере подготовки).
- `ui/exolynk_sales_workspace.html` — интерактивный прототип рабочего места.
