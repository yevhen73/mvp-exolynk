# Процесс: сопровождение заказа (Sales Workspace MVP)

Документ детализирует шаги целевого процесса, отображаемого в рабочем месте продаж. Основой служит модель состояний и ролей из бизнес-требований.

## 1. Стартовые условия
- Есть клиент (запись в `Kontakt`).
- Sales авторизован в Exolynk и работает в workspace «Sales».

## 2. Основной поток
1. **Создание заказа (Sales)**  
   Sales создаёт запись `Order` — система присваивает состояние `NEW`. Продавец заполняет позиции `OrderItem`, комментарии, плановую дату отгрузки.
2. **Автоматический контроль**  
   Если сумма > 10 000 CHF или есть другие ограничения, платформа автоматически переводит заказ в `APPROVAL`. Sales не может выбрать это состояние вручную.
3. **Комплектация (Sales)**  
   Когда требуется комплектация, Sales переводит заказ в `PICKING` (единственное действие по продвижению вперёд). Также продавец может закрыть заказ как неуспешный (`CLOSED` с флагом `closed_success=false`).
4. **Подтверждения менеджера**  
   Manager выполняет два действия: подтверждает заказ на комплектацию (фактически принятие `APPROVAL → PICKING`, если контроль сработал) и устанавливает флаг «Заказ оплачен» (`payment_state=YES`). Отчёты менеджер получает вне процесса.
5. **Комплектация (Logistics)**  
   Логистика переводит заказ из `PICKING` в `READY`, обновляет `shipment_state=READY`, заполняет `ship_date` и отправляет уведомление менеджеру.
6. **Закрытие (Manager)**  
   После оплаты менеджер переводит заказ в `CLOSED` с `closed_success=true`.

В любой момент Sales может завершить его как неуспешный (`CLOSED`, `closed_success=false`, `close_reason=*`).

## 3. Дополнительные сценарии
- **Отгрузка:** системный сервис устанавливает `shipment_state=SHIPPED` после подтверждения.
- **История состояний:** используем встроенный аудит Exolynk.

## 4. Переходы состояний (кратко)
```
NEW --(auto control)--> APPROVAL --(Manager confirm)--> PICKING --(Logistics)--> READY --(Manager payment flag)--> CLOSED(success)
       \                                                   
        \--(Sales close fail)----------------------------------> CLOSED(fail)
```

## 5. Уведомления
- `svc_notify_manager_approval`
- `svc_notify_logistics_picking`
- `svc_notify_manager_payment`
- `svc_close_success`

## 6. Связанные артефакты
- `diagrams/plantuml/` — диаграммы процесса (будет дополнено).
- `ui/exolynk_sales_workspace.html` — прототип интерфейса.
- `docs/requirements/business_requirements.md` — бизнес-требования.
